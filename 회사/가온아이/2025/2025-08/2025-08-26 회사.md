#2025-08-26 #2025-08 #2025- 
#회사 #점심 #닭칼국수

------
# 링크 
[[2025-08-26]]
[[커리큘럼]]
[[인증방식(글)]]


---
## 오늘의 할 일
- [x] myofficeCore 관리자에서 소스코드 분석 및 직접 수정
    - [x] 조직도 관리, 사원추가 Primary Mail에서 ezEmail/AdminRemote/MailGetDomainList 호출 했지만 404 에러 확인
- [ ] ![[Pasted image 20250826103005.png]]
- [x] 인증방식 및 구조 파악
    - [ ] A. 인증 방식까진 확인 완료 [[인증방식(글)]]
---
## 회의 메모
- 
---
## 오늘 배운 것
1. 오전
    1. 
2. 오후
    1. 
---
## Next Day 해야할 일
1. 인증방식 구조에 대해 더 여쭤보기 


## 있었던 일 or 메모
AuthHelper.cs
ezEKPAuthAttribute.cs
ezPortalBaseController.cs
BaseController.cs
UserHelper.cs
MainController.cs
CommonController.cs
EKPHomeController.cs

EKPHomeController.cs에서
index에서 AuthHelper.AuthUserValidationCheck(-> AuthHelper.isLogin(로그인 여부 확인 -> CookieHelpger.GetLoginCookie(쿠키명 분기)))에서
인증 상태인지, 비인증 상태인지 분기후 각각 
로그인 페이지, CreateUserProc로 이동


인증된 상태일 경우 = {CommonController() CreateUserProc로 올경우
ReplaceXSS로 XSS방지 및 
UserHelp.GetUserId로 GetLoginCookie로 userid 가져오고
ezHomeService에서 IE버전 조회해놓고
만약 userid나 IE 버전 낮으면 강제로그아웃
문제 없을경우 CreateUserInfo로 base.CreateUserInfo에서 컨트롤러에서 전달받은
userid 이용하여 사용자 정보생성하여
받은 값을 각 userinfo, RM에 저장
NetHttpHelper.getBasicAuthPassword(기본인증 헤더에서 비밀번호 추출) 값 가져와서
UpdateUserInfo(사용자 정보 업데이트, 비밀번호는 암호화) 및 UpdateConnectionLog 남기고 만약 로그인한 id가 "masteradmin" 일경우 관리자페이지("~/ezHome/Admin/IndexAdmin")로 이동
아닐 경우 일반 사용자 메인 페이지("~/ezPortal/Main/IndexPortal")로 이동 }

로그인 페이지 {
IActionResult Login에서
리소스 직접 설정 및 _homeService.LoginButtonClick_ 에 값이 Null이 아닌경우 리다이렉트
문제 없을경우 각종 쿠키에 보관된 ID체크, 언어 리소스 설정, 사용자화면에서 받아온
ID, PW를 복호화해서 CheckPassword를 통해 각각 isUserExist, isUserExitByCompany등 이중 체크하여 있는 아이디 자체가 TBLUserMaster 테이블에 있는지 조회후 _ezOrgan.CheckPassword_ 안에서 계정이 AD, EXCH, 0365, HYBRID 인지 각종 조회 후 
AD일 경우 비밀번호 만료 여부 체크 비밀번호, 만료일자, 인증 실패시 계정사용 안함이나 패스워드 오류를 반환 값을 chkResult에 담고 라이센스 체크 라이센스 문제 없을시 인증 성공시 처리로 넘어와 로그인 암호정책을 통해 비밀번호 미스카운트 수 체크 문제 없을시 
UpdatePWMissCount를 통해 (EZSP_UPDATE_PWMISSCOUNT)비밀번호에 MISSCOUNT를 9999로 업데이트 후 2차인증, 등 건너뛰고 중복 쿠키 있을경우 제거 없을경우 CookieHelper.SetLoginCookie 통해 로그인 쿠키 생성 및 멀티 로그인 사용 조회 모두 문제 없을시 result(redirectUrl = "~/ezHome/Common/CreateUserInfoProc";)로 값 보내기
resultModel에 값 담았는데 결과가 없고 , strResult1 =  null, "", " " 같은 반환 문제 있을 경우 로그인 페이지로 리다이렉트 문제 없을경우 resultModel에 strResult 값 담아서 리다이렉트

값 담긴 쿠키에서 걸려서 인증 완료
}




1. localhost:5267 접근 
    1. program.cs(엔드포인트 MapControllerRoute)  통해서 /EKPHome/index 라우팅
    2. MainController(EnvironStartPage)
    3. ezEKPAuthAttribute()
2. 비인증 상태 로그인 버튼 누를시
    1. BaseNoAuthContoller.cs를 상속 받은 BaseService(CreateUserInfo)

# 1) 최상위 흐름 (Entry → 분기)

- **EKPHomeController.Index**
    - `AuthHelper.AuthUserValidationCheck()` → 내부에서 `AuthHelper.isLogin()` → `CookieHelper.GetLoginCookie()`(쿠키명 분기)
    - **인증됨** → `~/ezHome/Common/CreateUserInfoProc`로 Redirect
    - **비인증** → `~/EKPHome/Login`(또는 기존 `/Login.aspx`)로 Redirect
---

# 2) 인증 경로 (CreateUserInfoProc 진입 시)
- **CommonController.CreateUserInfoProc**
    1. `ReplaceXSS`로 입력값 XSS 방지
    2. `UserHelper.GetUserId()` → 내부적으로 `GetLoginCookie()`로 `userid` 추출
    3. `ezHomeService`에서 **IE 버전 조회**
    4. **차단 조건**
        - `userid` 없음 OR IE 버전 낮음 ⇒ **강제 로그아웃**
    5. **정상일 때** → `CreateUserInfo` 호출
        - `base.CreateUserInfo(userid)` 실행
        - 반환된 사용자 정보 → **UserInfo**, **RM**에 저장(다국어 리소스 등)
    6. `NetHttpHelper.getBasicAuthPassword()`로 **기본 인증 헤더의 비밀번호** 추출
    7. `UpdateUserInfo()` (사용자 정보 업데이트, **비밀번호 암호화**)
        - `UpdateConnectionLog()` 남김
    8. **권한 분기**
        - 로그인 ID가 `"masteradmin"` ⇒ `~/ezHome/Admin/IndexAdmin`로 이동
        - 그 외 ⇒ `~/ezPortal/Main/IndexPortal`로 이동

---
# 3) 로그인 페이지 경로 (EKPHomeController.Login)
- **IActionResult Login**
    1. **리소스 직접 설정**
    2. `_homeService.LoginButtonClick_` 값이 **null 아님** ⇒ 해당 URL로 **Redirect**
    3. **문제 없음(계속 진행)**:
        - 쿠키에 저장된 **ID 체크**
        - **언어 리소스** 설정
        - 사용자 화면에서 받은 **ID/PW 복호화**
    4. **계정 존재 이중 체크**
        - `CheckPassword`가 `isUserExist`, `isUserExistByCompany` 확인
        - `TBLUserMaster`에서 사용자 존재 여부 조회
    5. **인증 방식 분기** (`_ezOrgan.CheckPassword_`)
        - **AD / EXCH / O365 / HYBRID** 타입 검사
        - AD인 경우 **비밀번호 만료** 여부, 만료일자 확인
        - 실패 시: **계정 사용 안함**, **패스워드 오류** 등 사유를 `chkResult`로 반환
    6. **라이선스 체크** 통과
    7. **인증 성공 처리**
        - **로그인 암호정책**(미스 카운트 등) 확인
        - `UpdatePWMissCount`(프로시저 `EZSP_UPDATE_PWMISSCOUNT`)로 **MissCount를 9999로 업데이트**
        - (2차 인증 등) **스킵**
        - **중복 쿠키 제거**(있으면)
        - `CookieHelper.SetLoginCookie()`로 **로그인 쿠키 생성**
        - **멀티 로그인 사용** 여부 확인
        - 최종 **resultModel.redirectUrl = "~/ezHome/Common/CreateUserInfoProc"` 셋
    8. **결과 분기**
        - `resultModel == null` **또는** `string.IsNullOrWhiteSpace(resultModel.strResult1)` ⇒ **로그인 페이지 재진입**
        - 그 외(정상) ⇒ `resultModel`의 `redirectUrl`로 **Redirect**
            
> 요점: **쿠키 생성** → **CreateUserInfoProc**로 이동 → 사용자정보/리소스 세팅 → 권한에 따라 **Admin/Portal**로 최종 진입.

# 처리 못한일