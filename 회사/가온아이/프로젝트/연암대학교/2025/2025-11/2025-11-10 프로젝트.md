#2025-11-10 #2025-11 #2025- 
#회사 #프로젝트 #연암대학교


------
# 링크 
[[2025-11-10 회사]]

---
## To Day 할 일
- [x] 문서번호  필드가 없던 문서들 문서번호 필드를 최대한 사용자에게 영향도가 없도록 수정
      (폰트 사이즈, 투명색, 쉘보호)
- [ ] 마지막 접속 ip 기능 추가
---
## 회의 메모
- 
---
## 오늘 배운 것
1. 오전
    1. 
2. 오후
    1. 
---
## 메모
Web.ezEKP.Core 프로젝트 게시전
파일 게시 옵션 
- 게시 전에 모든 기존 파일 삭제 체크
게시 후 나온 폴더중에
.playwrite, wwwroot/ezEditor, appsetting.json, Web.config 폴더는 제거 후에 zip으로 압축후 IIS 돌고 있는 웹서버 폴더에 복사 붙여넣기


  - 로그인 직후 업데이트
      - 위치: Kaoni.ezStandard.Web.ezEKP.Core/Areas/ezHome/Services/ezHomeService.cs:104
      - 동작: CreateUserInfoProc에서 UpdateUserInfo(...) 호출 → SP EZSP_SETUSERINFO 실행으로 사용자 기본정보와 접속 관련 필드 갱신(LastLoginDisplay, IP 등 DB 내 로직에서 업데이트). SP 정의는 DB에 있으며 소스엔 매핑이 없습니다.
      - 구현: Kaoni.ezStandard.Web.ezEKP.Core/Areas/ezHome/Services/ezHomeService.cs:3505 내부에서 sqlCom.CommandText = "EZSP_SETUSERINFO" 설정 후 ExecuteSP("ezCommon", ...) 호출.
  - 접속 유지(주기적) 업데이트
      - 엔드포인트: Kaoni.ezStandard.Web.ezEKP.Core/Areas/ezHome/Controllers/CommonController.cs:964
      - 호출: UpdateConnectInfo() → ezHomeService.UpdateConnectInfo(userId) 실행
      - 동작: EZSP_UPDATE_CONNECTINFO로 COM_TBLUSERINFO.LastConnect와 IPAddress 갱신(활동 중 접속 시간/아이피 추적).
      - SQL: Kaoni.ezStandard.Web.ezEKP.Core/SqlMap/ORACLE/ezCommon.xml:9-10
          - UPDATE COM_TBLUSERINFO SET LastConnect=SYSDATE, IPAddress=:v_IPADDRESS ...
  - 마지막 접속시간 조회(화면 표시용)
      - 서비스: Kaoni.ezStandard.Web.ezEKP.Core/Areas/ezPortal/Services/ezPortalMainService.cs:705
      - 동작: SetLastLoginTime(userId, offset) → SP EZSP_WPCONT_LOGINTIME로 COM_TBLUSERINFO.LastLoginDisplay 조회 후 GetLocalTime(...)로 타임존 변환
      - SQL: Kaoni.ezStandard.Web.ezEKP.Core/SqlMap/ORACLE/ezCommon.xml:76-78
  - 마지막 접속 IP 조회(참고)
      - 서비스: Kaoni.ezStandard.Web.ezEKP.Core/Areas/ezPortal/Services/ezPortalMainService.cs:733
      - 동작: SetLastLoginIP(userId) → SP EZSP_GET_LAST_LOGIN_IP 결과 사용(매핑은 DB에 존재)
  - 로그아웃 시 처리(참고)
      - 위치: Kaoni.ezStandard.Web.ezEKP.Core/Services/HomeService.cs:887, :894
      - SQL: Kaoni.ezStandard.Web.ezEKP.Core/SqlMap/ORACLE/ezCommon.xml:143-144 (EZSP_LOGOUT, LastConnect 조정)
      - 목적: 동시접속/세션 정책용, “마지막 접속시간” 표시 값과는 별개

  정리: “마지막 접속시간”은 로그인 성공 시 DB SP(EZSP_SETUSERINFO)에서 갱신되고, 화면에서는 EZSP_WPCONT_LOGINTIME로 읽어 보여줍니다. 접속 유지 중에는 별도의 주기 호출로 LastConnect가 갱신되지만, 화면의 “마지막 접속시간” 표시값은 로그인 시각(LastLoginDisplay)을 기준으로
  합니다.

------------------ 
# 🧩 EZSP_SETUSERINFO & LastLoginIP 개선 설계서

## 📌 개요

사용자의 **이전 로그인 IP**를 안정적으로 보관하기 위해  
`TBLUSERINFO`에 `LastLoginIP` 컬럼을 추가하고,  
로그인 시점에만 갱신되도록 `dbo.EZSP_SETUSERINFO` 프로시저를 수정한다.

---

## ⚙️ 구현 순서

### 1️⃣ DB 컬럼 추가

`ALTER TABLE dbo.TBLUSERINFO ADD LastLoginIP VARCHAR(50) NULL;`

- 기존 `IPAddress`는 “현재 접속 IP”
    
- 새 컬럼 `LastLoginIP`는 “직전 로그인 IP”
    

---

### 2️⃣ 프로시저 수정 – `dbo.EZSP_SETUSERINFO`

#### 🔸 UPDATE 절 (핵심)

`UPDATE dbo.TBLUSERINFO    SET LastLoginDisplay = LastLogin,        LastLoginIP = IPAddress,         -- 직전 로그인 IP 저장        LastLogin = GETDATE(),        IPAddress = @PIPADDRESS          -- 현재 로그인 IP 갱신 WHERE USERID = @PUSERID;`

#### 🔸 INSERT 절 (권장안)

`INSERT INTO dbo.TBLUSERINFO (     USERID, USERNAME, LastLogin, LastLoginIP, IPAddress, ... ) VALUES (     @PUSERID, @PUSERNAME, GETDATE(),     NULL,                 -- 최초 로그인 시 LastLoginIP 없음     @PIPADDRESS, ... );`

> 💡 정책 선택:
> 
> - `LastLoginIP = NULL` → 화면에서 NULL이면 “현재 IP”로 대체 표시
>     
> - 혹은 `LastLoginIP = @PIPADDRESS` → 동일 IP로 초기화
>     

---

### 3️⃣ 조회용 SP 생성

`CREATE PROCEDURE dbo.EZSP_GET_LAST_LOGIN_IP     @USERID VARCHAR(50) AS BEGIN     SELECT ISNULL(LastLoginIP, IPAddress) AS LastLoginIP     FROM dbo.TBLUSERINFO WITH (NOLOCK)     WHERE USERID = @USERID       AND LOGINTYPE = 'W'; END`

- NULL이면 자동으로 현재 IP(`IPAddress`)로 대체 표시.
    

---

## 🧠 애플리케이션 반영 위치

|위치|설명|
|---|---|
|`Kaoni.ezStandard.Web.ezEKP.Core/Areas/ezPortal/Services/ezPortalMainService.cs` (line 733)|`SetLastLoginIP(userId)` 호출 유지|
|`IndexPortal.cshtml:88`|표시부 그대로 사용 (NULL이면 현재 IP로 표시)|
|SQLMap (Oracle용만)|매핑 추가 필요, MSSQL은 SP 자동 호출됨|

---

## 🔍 고려사항

|구분|내용|
|---|---|
|**Keepalive와 분리**|`EZSP_UPDATE_CONNECTINFO` 호출로 `IPAddress` 갱신돼도 `LastLoginIP`는 로그인 시점만 갱신됨.|
|**동시 로그인**|거의 동시에 두 번 로그인 시, 저장 순서에 따라 마지막 저장자가 직전 IP로 기록됨. 완전 정밀도를 원하면 `EZSP_CONNECTION_USER_LOG` 기반 “두 번째 최신 로그인” 조회 방식 고려.|
|**최초 로그인 UX**|`LastLoginIP = NULL`이면 공란 또는 현재 IP로 표시 선택.|
|**프록시 환경**|`NetHttpHelper.GetClientIP()`가 `X-Forwarded-For` 신뢰 가능한 경우에만 사용하도록 설정 필요.|

---

## 🧪 테스트 체크리스트

| 시나리오                 | 기대 결과                                   |
| -------------------- | --------------------------------------- |
| 최초 로그인               | `LastLoginIP` NULL → 화면에 현재 IP 표시       |
| 연속 로그인 2회            | 두 번째 로그인 시 “마지막 접속 IP”가 첫 번째 로그인 IP로 표시 |
| 세션 유지 중 Keepalive 호출 | `LastLoginIP` 변하지 않음                    |
| 다중 기기 동시 로그인         | 마지막 로그인 순서대로 `LastLoginIP` 덮어쓰기 확인      |
|                      |                                         |
TBLUSERINF = LastLoginIP varchar(50) add
EZSP_SETUSERINFO = UPDATE와 INSERT에 LastLoginIP = IPAddress, NULL 추가 

EZSP_GET_LAST_LOGIN_IP 
```sql
CREATE PROCEDURE [dbo].[EZSP_GET_LAST_LOGIN_IP]

@pUSERID VARCHAR(50)
AS
BEGIN

SET NOCOUNT ON;
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED;

SELECT ISNULL(LastLoginIP, IPAddress) AS LASTLOGINIP
FROM dbo.TBLUSERINFO WITH (NOLOCK)
WHERE UserID = @pUSERID
AND LOGINTYPE = 'W';

END
```

# ## Next Day 해야할 일
1. 개발 웹 서버에 기능 추가한 소스 코드 반영 및 개발 db 테이블 컬럼 추가 및 프로시저 생성 수정 
