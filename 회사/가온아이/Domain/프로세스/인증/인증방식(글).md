[[2025-08-26 회사]]

# 1) 최상위 흐름 (Entry → 분기)

- **EKPHomeController.Index**
    - `AuthHelper.AuthUserValidationCheck()` → 내부에서 `AuthHelper.isLogin()` → `CookieHelper.GetLoginCookie()`(쿠키명 분기)
    - **인증됨** → `~/ezHome/Common/CreateUserInfoProc`로 Redirect
    - **비인증** → `~/EKPHome/Login`(또는 기존 `/Login.aspx`)로 Redirect
---

# 2) 인증 경로 (CreateUserInfoProc 진입 시)
- **CommonController.CreateUserInfoProc**
    1. `ReplaceXSS`로 입력값 XSS 방지
    2. `UserHelper.GetUserId()` → 내부적으로 `GetLoginCookie()`로 `userid` 추출
    3. `ezHomeService`에서 **IE 버전 조회**
    4. **차단 조건**
        - `userid` 없음 OR IE 버전 낮음 ⇒ **강제 로그아웃**
    5. **정상일 때** → `CreateUserInfo` 호출
        - `base.CreateUserInfo(userid)` 실행
        - 반환된 사용자 정보 → **UserInfo**, **RM**에 저장(다국어 리소스 등)
    6. `NetHttpHelper.getBasicAuthPassword()`로 **기본 인증 헤더의 비밀번호** 추출
    7. `UpdateUserInfo()` (사용자 정보 업데이트, **비밀번호 암호화**)
        - `UpdateConnectionLog()` 남김
    8. **권한 분기**
        - 로그인 ID가 `"masteradmin"` ⇒ `~/ezHome/Admin/IndexAdmin`로 이동
        - 그 외 ⇒ `~/ezPortal/Main/IndexPortal`로 이동

---
# 3) 로그인 페이지 경로 (EKPHomeController.Login)
- **IActionResult Login**
    1. **리소스 직접 설정**
    2. `_homeService.LoginButtonClick_` 값이 **null 아님** ⇒ 해당 URL로 **Redirect**
    3. **문제 없음(계속 진행)**:
        - 쿠키에 저장된 **ID 체크**
        - **언어 리소스** 설정
        - 사용자 화면에서 받은 **ID/PW 복호화**
    4. **계정 존재 이중 체크**
        - `CheckPassword`가 `isUserExist`, `isUserExistByCompany` 확인
        - `TBLUserMaster`에서 사용자 존재 여부 조회
    5. **인증 방식 분기** (`_ezOrgan.CheckPassword_`)
        - **AD / EXCH / O365 / HYBRID** 타입 검사
        - AD인 경우 **비밀번호 만료** 여부, 만료일자 확인
        - 실패 시: **계정 사용 안함**, **패스워드 오류** 등 사유를 `chkResult`로 반환
    6. **라이선스 체크** 통과
    7. **인증 성공 처리**
        - **로그인 암호정책**(미스 카운트 등) 확인
        - `UpdatePWMissCount`(프로시저 `EZSP_UPDATE_PWMISSCOUNT`)로 **MissCount를 9999로 업데이트**
        - (2차 인증 등) **스킵**
        - **중복 쿠키 제거**(있으면)
        - `CookieHelper.SetLoginCookie()`로 **로그인 쿠키 생성**
        - **멀티 로그인 사용** 여부 확인
        - 최종 **resultModel.redirectUrl = "~/ezHome/Common/CreateUserInfoProc"` 셋
    8. **결과 분기**
        - `resultModel == null` **또는** `string.IsNullOrWhiteSpace(resultModel.strResult1)` ⇒ **로그인 페이지 재진입**
        - 그 외(정상) ⇒ `resultModel`의 `redirectUrl`로 **Redirect**
            
> 요점: **쿠키 생성** → **CreateUserInfoProc**로 이동 → 사용자정보/리소스 세팅 → 권한에 따라 **Admin/Portal**로 최종 진입.
