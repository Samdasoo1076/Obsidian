








28p
  1. '결재 상신' (최초 기안) 시의 흐름

  이것은 사용자가 DraftUI.cshtml에서 [결재 상신] 버튼을 눌렀을 때의 흐름입니다.
   * `SaveDraftDocInfo_ilban()` (JS) -> `DraftUIAspxController/DoDraft` 호출
   * `Service/DoDraft()` -> `library/doProcess()` 호출 (이때 결재 상태는 '기안 진행중')
   * `doProcess()` -> `UpdateDocInfo()` 호출
   * `UpdateDocInfo()` -> `EZSP_UPDATEDOCINFO` 프로시저 호출 및 동적 SQL(UPDATE, INSERT) 생성

  결론: '결재 상신' 시점에는 UpdateDocInfo를 통해 새로운 문서를 DB에 생성하는 작업만 일어납니다. 이 과정에서 doApprove 함수는 호출되지 않습니다.
  2. '결재 승인' 시의 흐름이것은 결재자가 ApprovUI.cshtml에서 [승인] 버튼을 눌렀을 때의 흐름입니다.
   * (다른 경로로) `library/doProcess()` 호출 (이때 결재 상태는 '승인')
   * `doProcess()` -> UpdateDocInfo()를 호출하여 문서 정보를 업데이트하고, 추가로 `doApprove()`를 호출하여 결재 상태를 변경합니다.
   * `doApprove()` -> 내부에서 말씀하신 `EZSP_DOAPPROVE_APRLINEINFO` 와 `EZSP_DOAPPROVE_NEXTUSER` 프로시저를 호출하여 다음 결재자를 처리합니다. (EZSP_TBAPRLINEINFO는 확인되지 않았습니다.)


29p '결재 승인' 흐름 상세 분석
  1단계: `DoApprov` 서비스 메서드 호출
   * 실행 위치: ApprovUIAspxController.cs의 DoApprov() 액션 메서드
   * 호출 대상: ezApprovalApprovUIAspxService.cs의 DoApprov() 메서드
   * 호출 이유: 컨트롤러가 받은 '승인' 요청을 실제 비즈니스 로직을 처리하는 서비스에게 넘겨주기 위함입니다.
   * 함수 상세 설명: 컨트롤러는 웹 요청의 진입점 역할을 하며, 받은 데이터를 검증하거나 가공하지 않고 그대로 서비스 메서드로 전달합니다.
   * 전달 값: pDocID, pUserID, xmldom 등 클라이언트로부터 받은 모든 정보
   * 반환 값: DoApprov 서비스 메서드가 반환하는 결과(XML 문자열)
  2단계: `doProcess` 라이브러리 메서드 호출
   * 실행 위치: ezApprovalApprovUIAspxService.cs의 DoApprov() 메서드
   * 호출 대상: ezWorkFlow.cs의 doProcess() 메서드
   * 호출 이유: '승인'에 대한 모든 정보를 핵심 로직이 담긴 doProcess에게 전달하여 최종 처리를 위임하기 위함입니다.
   * 함수 상세 설명: 이 서비스 메서드는 ezWorkFlow 라이브러리를 호출하는 '다리' 역할을 합니다. '승인'을 의미하는 상태 코드 `"A04003"` 과 함께 모든 데이터를 doProcess로 넘깁니다.
   * 전달 값: pAprState("A04003"), pDocID, pUserID, xmldom 등
   * 반환 값: doProcess가 반환하는 최종 결과(XML 문자열)
  3단계: `UpdateDocInfo` 함수 호출
   * 실행 위치: ezWorkFlow.cs의 doProcess() 메서드
   * 호출 대상: 같은 파일(ezWorkFlow.cs)의 UpdateDocInfo() 함수
   * 호출 이유: 결재 상태를 변경하기 전에, 문서의 제목이나 기타 속성 등 변경된 내용이 있다면 먼저 DB에 반영하기 위함입니다.
   * 함수 상세 설명: EZSP_UPDATEDOCINFO 프로시저를 호출하고, 동적으로 UPDATE 및 INSERT SQL 쿼리를 조립하여 'SQL 쿼리 묶음'을 생성합니다.
   * 전달 값: pstrXML (모든 문서 정보가 담긴 XML)
   * 반환 값: 조립된 'SQL 쿼리 묶음' (문자열)
  4단계: `doApprove` 함수 호출
   * 실행 위치: ezWorkFlow.cs의 doProcess() 메서드
   * 호출 대상: 같은 파일(ezWorkFlow.cs)의 doApprove() 함수
   * 호출 이유: UpdateDocInfo가 끝난 후, 실질적인 결재 상태 변경 및 다음 결재자에게 문서를 넘기는 작업을 수행하기 위함입니다.
   * 함수 상세 설명: 현재 결재자의 상태를 '승인'으로 바꾸고, 다음 결재자의 상태를 '진행중'으로 바꾸는 등의 SQL 쿼리를 생성합니다. 이 과정에서 여러 저장 프로시저를 호출합니다.
   * 전달 값: pDocID, pUserID 등
   * 반환 값: 조립된 'SQL 쿼리 묶음' (문자열)
  5단계: `EZSP_DOAPPROVE_APRLINEINFO` 프로시저 호출
   * 실행 위치: ezWorkFlow.cs의 doApprove() 메서드 내부
   * 호출 대상: 데이터베이스의 EZSP_DOAPPROVE_APRLINEINFO 저장 프로시저
   * 호출 이유: 현재 결재자의 정확한 정보(순번, 타입 등)를 DB에서 조회하기 위함입니다.
   * 함수 상세 설명: TBAPRLINEINFO 테이블에서 현재 사용자의 결재선 정보를 조회합니다.
   * 전달 값: pDocID, pUserID
   * 반환 값: 현재 결재 단계의 정보 (XML)
  6단계: `EZSP_DOAPPROVE_NEXTUSER` 프로시저 호출
   * 실행 위치: ezWorkFlow.cs의 doApprove() 메서드 내부
   * 호출 대상: 데이터베이스의 EZSP_DOAPPROVE_NEXTUSER 저장 프로시저
   * 호출 이유: 현재 결재자 처리 후, 다음 순번의 결재자 정보를 조회하기 위함입니다.
   * 함수 상세 설명: TBAPRLINEINFO 테이블에서 다음 순번의 결재자 정보를 조회합니다.
   * 전달 값: pDocID, 현재 결재자 순번
   * 반환 값: 다음 결재자의 정보 (XML)

30p
  '최종 기안' 시 UpdateDocInfo 호출 및 DB 업데이트 흐름
  1단계: `doProcess` -> `UpdateDocInfo` 호출
   * 실행 위치: ezWorkFlow.cs의 doProcess() 메서드
   * 호출 대상: 같은 파일의 UpdateDocInfo() 함수
   * 호출 이유: '결재 상신' 요청을 받았으므로, 문서의 모든 정보를 데이터베이스에 저장하는 작업을 시작하기 위해 호출합니다.
   * 함수 상세 설명: 문서 저장에 필요한 모든 SQL 쿼리(저장 프로시저 호출, UPDATE문, INSERT문)를 조립하는 'SQL 쿼리 빌더' 역할을 합니다.
   * 전달 값: pstrXML (문서의 모든 정보가 담긴 XML 문자열)
   * 반환 값: 완성된 SQL 쿼리 묶음 (문자열)
  2단계: `UpdateDocInfo` -> `EZSP_UPDATEDOCINFO` 호출
   * 실행 위치: ezWorkFlow.cs의 UpdateDocInfo() 메서드
   * 호출 대상: 데이터베이스의 EZSP_UPDATEDOCINFO 저장 프로시저
   * 호출 이유: 전체 문서 정보를 업데이트하기 전에, 가장 핵심적인 정보인 문서 제목과 파일 경로를 먼저 DB에 기록하여 데이터 정합성을 확보하기 위함입니다.
   * 함수 상세 설명: TBAPRDOCINFO 테이블의 특정 문서에 대해 DocTitle과 Href 컬럼만 UPDATE하는 매우 구체적인 역할을 수행합니다.
   * 전달 값: @PDOCID (문서 ID), @PHREF (파일 경로), @PDOCTITLE (문서 제목)
   * 반환 값: (없음 - UPDATE만 수행)


31p
✦ 네, doApprove 메서드의 역할에 대해 질문해주셨군요. 여기서 가장 중요한 점을 먼저 명확히 해야 합니다.

  doApprove 메서드는 '결재 상신' 시점에는 호출되지 않습니다. 이 메서드는 상신된 문서의 결재자가 '승인' 버튼을 눌렀을 때 호출되는 함수입니다.

  하지만, '승인' 시에 doApprove가 호출되었을 때 일어나는 일에 대한 설명은 정확합니다. 그 과정을 상세히 설명해 드리겠습니다.

  ---
  '승인' 시 doApprove 메서드 상세 분석
  분석 대상:
   * C:\NET8Curr\net-8-curr\Kaoni.ezStandard.Core\Library_Core\Kaoni.ezStandard.ezApproval.Core\ezWorkFlow.cs 파일의 doApprove 메서드
  핵심 역할:
   * 현재 결재자의 상태를 '완료'로 변경하고, 다음 결재자가 있다면 그 결재자의 상태를 '진행중'으로 만들어 결재 흐름을 이어주는 역할을 합니다.
  상세 동작 순서:
   1. 현재 결재자 정보 조회
       * 말씀하신 대로, `EZSP_DOAPPROVE_APRLINEINFO` 저장 프로시저를 호출합니다.
       * 이를 통해 현재 승인 버튼을 누른 사용자가 결재선의 몇 번째 순번인지, 어떤 결재 유형인지 등의 정보를 DB에서 가져옵니다.
   2. 현재 결재자 상태 업데이트
       * 가져온 정보를 바탕으로, TBAPRLINEINFO 테이블에서 현재 결재자의 AprState를 '완료'(staASSungIn)로, ProcessDate를 현재 시각으로 UPDATE하는 SQL 쿼리를 생성합니다.
   3. 다음 결재자 정보 조회
       * `EZSP_DOAPPROVE_NEXTUSER` 저장 프로시저를 호출하여, 다음 순번의 결재자가 있는지, 있다면 누구인지 정보를 가져옵니다.
   4. 다음 결재자 상태 업데이트
       * 만약 다음 결재자가 있다면, 그 결재자의 AprState를 '진행중'(staASJinHang)으로, ReceivedDate를 현재 시각으로 UPDATE하는 SQL 쿼리를 생성합니다. 그리고 다음 결재자에게 알림을 보냅니다.
   5. 최종 결재 완료 처리
       * 만약 다음 결재자가 없다면, 이 승인이 최종 결재임을 의미합니다.
       * 이 경우, doDocComplete 함수를 호출하여 문서 전체의 상태를 '완료'로 변경하고 파일을 최종 경로로 이동시키는 등의 마무리 작업을 시작합니다.


33p
  '최종 기안' 완료 처리 흐름 분석

  1단계: 결재선 이력 업데이트 (`UpdateLineHistory`)

   * 실행 위치: Draft.js의 Draft_Complete() 함수 내부에서, SaveDraftDocInfo()보다 먼저 호출됩니다.
   * 호출 대상: ezHistory.js의 UpdateLineHistory() 함수 (추정)
   * 호출 이유: 결재를 상신하기 직전의 최종 결재선 정보를 이력으로 남기기 위함입니다.
   * 상세 설명:
       1. UpdateLineHistory() 함수는 서버의 `/ezAPRHISTORYAspx/UpdateLineHistory` 주소로 AJAX 요청을 보냅니다.
       2. ezAPRHISTORYAspxController는 이 요청을 받아 ezApprovalHistoryAspxService를 호출합니다.
       3. 서비스는 ezHistory 라이브러리의 UpdateHistoryForLine() 메서드를 호출합니다.
       4. UpdateHistoryForLine() 메서드는 최종적으로 `EZSP_UPDATEHISTORYFORLINE` 저장 프로시저를 호출하여, TBAPRLINEHISTORY와 같은 이력 테이블에 현재 결재선 정보를 기록합니다.

  2단계: 문서 저장 (`SaveDraftDocInfo`)

   * 이 부분은 저희가 바로 이전에 분석했던 '문서 채번' 및 '파일 저장'과 동일한 과정입니다. SaveFile()과 SaveDraftDocInfo_ilban()을 통해 파일과 문서 정보가 DB에 저장됩니다.

  3단계: 의견 저장 (`SaveOpinion_DocComplete`)

   * 실행 위치: Draft.js의 Draft_Complete() 함수 내부에서, SaveDraftDocInfo()가 성공적으로 TRUE를 반환한 후에 실행됩니다.
   * 호출 대상: ApprovUI.js의 SaveOpinion_DocComplete() 함수
   * 호출 이유: 사용자가 결재 상신 시점에 남긴 의견이 있다면, 그 내용을 DB에 저장하기 위함입니다.
   * 상세 설명:
       1. SaveOpinion_DocComplete() 함수는 의견 내용을 XML로 만들어 서버의 `/ezApproval/ezAPROPINIONAspx/OpinionSaveDocComplete` 주소로 AJAX 요청을 보냅니다.
       2. ezAPROPINIONAspxController는 이 요청을 받아 서비스를 호출하고, 서비스는 최종적으로 `EZSP_SAVEOPINION_DOCCOMPLETE` 와 같은 저장 프로시저를 호출하여 TBOPINIONINFO 테이블에 의견을 저장합니다.


37p
  '합의' 버튼 클릭 시 흐름 분석 (텍스트 버전)

  1단계: `btnApprove_onclick()` 함수 호출 및 사전 점검
   * 실행 위치: ApprovUI.js
   * 호출 이유: 사용자가 '합의' 버튼을 클릭했을 때, 전체 프로세스를 시작하기 위함입니다.
   * 상세 설명: 이 함수는 먼저 CheckApprov()를 호출하여 서버에 현재 사용자가 합의를 진행할 수 있는 상태인지 실시간으로 확인합니다. 검증이 완료되면, 결재 비밀번호나 의견 입력이 필요한지 확인하기 위해
     chk_Passwd() 함수를 호출합니다.

  2단계: `chk_Passwd()` 함수 호출 및 의견 입력창 표시
   * 실행 위치: ezDraft_Common.js
   * 호출 이유: btnApprove_onclick의 사전 점검이 완료된 후, 사용자 인증 및 의견 입력을 받기 위함입니다.
   * 상세 설명: 이 함수는 /ezApproval/Main/ezchkPasswd 주소로 팝업창을 띄워 사용자에게 의견 입력창을 보여줍니다. 사용자가 내용을 입력하고 '확인'을 누르면, 미리 지정된 콜백 함수인
     chk_Passwd_Approve_Complete가 실행됩니다.

  3단계: `chk_Passwd_Approve_Complete()` 함수 호출
   * 실행 위치: ApprovUI.js
   * 호출 이유: 의견 입력 팝업이 정상적으로 닫혔을 때, 그 후속 조치를 하기 위함입니다.
   * 상세 설명: 이 함수는 다음 단계인 서명 입력을 위해 openSignUI() 함수를 호출합니다.

  4단계: `openSignUI()` 함수 호출 및 서명 목록 조회
   * 실행 위치: ezDraft_Common.js
   * 호출 이유: chk_Passwd_Approve_Complete의 처리가 끝난 후, 사용자의 서명을 받기 위함입니다.
   * 상세 설명: 이 함수는 먼저 /ezAPRSIGNAspx/GetSignRequest 주소로 AJAX 요청을 보내, 사용자의 저장된 서명 목록을 가져옵니다. 그 후, 이 목록을 가지고 /ezAPRSIGN/AprSign 주소로 팝업창을 띄워 사용자에게 서명을
     선택하게 합니다.

  5단계: `openSignUI_Complete()` 함수 호출
   * 실행 위치: ApprovUI.js
   * 호출 이유: 서명 선택 팝업이 정상적으로 닫혔을 때, 최종 '합의' 처리를 하기 위함입니다.
   * 상세 설명: 이 함수는 '지휘자' 역할을 합니다. UpdateLineHistory()를 호출하여 결재 이력을 남기고, ApprovMappingSign()으로 서명을 화면에 적용하며, SaveOpinion_DocComplete()로 의견을 저장한 후, 최종적으로
     SaveApproveInfo()를 호출하여 모든 정보를 서버에 전송합니다.

  6단계: `SaveApproveInfo()` 함수 호출 및 서버 전송
   * 실행 위치: ApprovUI.js
   * 호출 이유: openSignUI_Complete의 모든 준비가 끝난 후, 최종 데이터를 서버에 보내기 위함입니다.
   * 상세 설명: 모든 정보를 종합하여 XML로 만든 뒤, 서버의 /ezApproval/ApprovUIAspx/DoApprov 주소로 '승인' 요청을 전송합니다. 서버에서는 이 요청을 받아 doProcess 메서드를 통해 DB 상태를 업데이트합니다.

